generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum Role {
  ADMIN
  GESTOR
  ALMOXARIFE
  VISUALIZADOR
}

enum StatusObra {
  ATIVA
  FINALIZADA
  PAUSADA
}

enum Unidade {
  UN
  KG
  M
  M2
  M3
  L
  CX
  PC
  SC
  TB
  GL
  FD
  RL
  PR
}

enum TipoMovimentacao {
  ENTRADA
  SAIDA
  TRANSFERENCIA
}

enum StatusTransferencia {
  PENDENTE
  APROVADA_NIVEL_1
  APROVADA
  REJEITADA
}

enum StatusNF {
  PENDENTE
  PROCESSADA
  VINCULADA
  REJEITADA
}

// ─── Models ──────────────────────────────────────────────

model Usuario {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  senha     String
  role      Role     @default(VISUALIZADOR)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  obras         UsuarioObra[]
  movimentacoes Movimentacao[]
  auditLogs     AuditLog[]
  refreshTokens RefreshToken[]

  @@map("usuarios")
}

model UsuarioObra {
  usuarioId String   @map("usuario_id")
  obraId    String   @map("obra_id")
  createdAt DateTime @default(now()) @map("created_at")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  obra    Obra    @relation(fields: [obraId], references: [id], onDelete: Cascade)

  @@id([usuarioId, obraId])
  @@map("usuario_obras")
}

model Obra {
  id        String     @id @default(uuid())
  nome      String
  endereco  String
  status    StatusObra @default(ATIVA)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  // Relations
  almoxarifados Almoxarifado[]
  usuarios      UsuarioObra[]

  @@map("obras")
}

model Almoxarifado {
  id        String   @id @default(uuid())
  nome      String
  obraId    String   @map("obra_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  obra                 Obra           @relation(fields: [obraId], references: [id], onDelete: Cascade)
  estoques             Estoque[]
  movimentacoesOrigem  Movimentacao[] @relation("almoxarifado_origem")
  movimentacoesDestino Movimentacao[] @relation("almoxarifado_destino")

  @@map("almoxarifados")
}

model Categoria {
  id        String   @id @default(uuid())
  nome      String   @unique
  unidade   Unidade
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  materiais Material[]

  @@map("categorias")
}

model Material {
  id            String   @id @default(uuid())
  nome          String
  codigo        String   @unique
  categoriaId   String   @map("categoria_id")
  estoqueMinimo Float    @default(0) @map("estoque_minimo")
  precoUnitario Float    @default(0) @map("preco_unitario")
  descricao     String?
  codigoBarras  String?  @map("codigo_barras")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  categoria     Categoria      @relation(fields: [categoriaId], references: [id])
  estoques      Estoque[]
  movimentacoes Movimentacao[]
  itensNF       ItemNF[]

  @@map("materiais")
}

model Estoque {
  id             String   @id @default(uuid())
  materialId     String   @map("material_id")
  almoxarifadoId String   @map("almoxarifado_id")
  quantidade     Float    @default(0)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  material     Material     @relation(fields: [materialId], references: [id])
  almoxarifado Almoxarifado @relation(fields: [almoxarifadoId], references: [id])

  @@unique([materialId, almoxarifadoId])
  @@map("estoques")
}

model Fornecedor {
  id         String   @id @default(uuid())
  nome       String
  cnpj       String?  @unique
  telefone   String?
  email      String?
  endereco   String?
  observacao String?
  ativo      Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  movimentacoes Movimentacao[]

  @@map("fornecedores")
}

model Movimentacao {
  id                    String               @id @default(uuid())
  tipo                  TipoMovimentacao
  materialId            String               @map("material_id")
  quantidade            Float
  precoUnitario         Float?               @map("preco_unitario")
  almoxarifadoId        String               @map("almoxarifado_id")
  almoxarifadoDestinoId String?              @map("almoxarifado_destino_id")
  fornecedorId          String?              @map("fornecedor_id")
  nfId                  String?              @map("nf_id")
  usuarioId             String               @map("usuario_id")
  observacao            String?
  unidade               String?
  formaPagamento        String?              @map("forma_pagamento")
  statusTransferencia   StatusTransferencia? @map("status_transferencia")
  createdAt             DateTime             @default(now()) @map("created_at")

  // Relations
  material            Material      @relation(fields: [materialId], references: [id])
  almoxarifado        Almoxarifado  @relation("almoxarifado_origem", fields: [almoxarifadoId], references: [id])
  almoxarifadoDestino Almoxarifado? @relation("almoxarifado_destino", fields: [almoxarifadoDestinoId], references: [id])
  fornecedor          Fornecedor?   @relation(fields: [fornecedorId], references: [id])
  notaFiscal          NotaFiscal?   @relation(fields: [nfId], references: [id])
  usuario             Usuario       @relation(fields: [usuarioId], references: [id])

  @@index([materialId])
  @@index([almoxarifadoId])
  @@index([createdAt])
  @@map("movimentacoes")
}

model NotaFiscal {
  id               String   @id @default(uuid())
  chaveAcesso      String   @unique @map("chave_acesso")
  cnpjEmitente     String   @map("cnpj_emitente")
  cnpjDestinatario String?  @map("cnpj_destinatario")
  numero           String
  serie            String
  dataEmissao      DateTime @map("data_emissao")
  valorTotal       Float    @map("valor_total")
  xmlUrl           String?  @map("xml_url")
  status           StatusNF @default(PENDENTE)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  itens         ItemNF[]
  movimentacoes Movimentacao[]

  @@index([cnpjEmitente])
  @@index([dataEmissao])
  @@map("notas_fiscais")
}

model ItemNF {
  id            String  @id @default(uuid())
  nfId          String  @map("nf_id")
  materialId    String? @map("material_id")
  descricao     String
  ncm           String?
  cfop          String?
  unidade       String
  quantidade    Float
  valorUnitario Float   @map("valor_unitario")
  valorTotal    Float   @map("valor_total")

  // Relations
  notaFiscal NotaFiscal @relation(fields: [nfId], references: [id], onDelete: Cascade)
  material   Material?  @relation(fields: [materialId], references: [id])

  @@map("itens_nf")
}

model AuditLog {
  id         String   @id @default(uuid())
  usuarioId  String   @map("usuario_id")
  acao       String
  entidade   String
  entidadeId String   @map("entidade_id")
  payload    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  usuario Usuario @relation(fields: [usuarioId], references: [id])

  @@index([entidade, entidadeId])
  @@index([usuarioId])
  @@index([createdAt])
  @@map("audit_logs")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  usuarioId String    @map("usuario_id")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")

  // Relations
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([usuarioId])
  @@map("refresh_tokens")
}
